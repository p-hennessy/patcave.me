<!DOCTYPE html><html lang="en-us"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>TF2Maps Infrastructure Overhaul Project - The Patcave</title><meta name="description" content="I have been Technical Staff at TF2Maps.net for about a year as of writing this. One of the big things that bothered me when I first got onboard was how disorganized and chaotic the state of the infrastructure was. There wasn't a lot of it&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://patcave.me/tf2maps-infrastructure-overhaul-project/"><link rel="amphtml" href="https://patcave.me/amp/tf2maps-infrastructure-overhaul-project/"><link rel="alternate" type="application/atom+xml" href="https://patcave.me/feed.xml"><link rel="alternate" type="application/json" href="https://patcave.me/feed.json"><link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin><link href="https://fonts.googleapis.com/css?family=Roboto+Condensed:400,700&amp;subset=latin-ext&amp;display=swap" rel="stylesheet"><style>:root{--body-font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";--heading-font:'Roboto Condensed',sans-serif;--logo-font:'Roboto Condensed',sans-serif;--menu-font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol"}</style><link rel="stylesheet" href="https://patcave.me/assets/css/style.css?v=4945aedf837c971c57d7192803b442c1"><link rel="stylesheet" href="https://patcave.me/assets/css/photoswipe.css?v=7331f6eb15671b2fc8e3ffd46e849f7b"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://patcave.me/tf2maps-infrastructure-overhaul-project/"},"headline":"TF2Maps Infrastructure Overhaul Project","datePublished":"2022-03-15T19:53","dateModified":"2022-04-22T02:52","image":{"@type":"ImageObject","url":"https://patcave.me/media/posts/12/blueprints.png","height":1080,"width":1920},"description":"I have been Technical Staff at TF2Maps.net for about a year as of writing this. One of the big things that bothered me when I first got onboard was how disorganized and chaotic the state of the infrastructure was. There wasn't a lot of it&hellip;","author":{"@type":"Person","name":"Patrick Hennessy"},"publisher":{"@type":"Organization","name":"Patrick Hennessy"}}</script><style>.pswp--svg .pswp__button,
				          .pswp--svg .pswp__button--arrow--left:before,
				          .pswp--svg .pswp__button--arrow--right:before {
					          background-image: url(https://patcave.me/assets/svg/gallery-icons-light.svg);
			              }</style><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Boogaloo&family=Maven+Pro&display=swap" rel="stylesheet"></head><body><div class="site-container"><header class="top" id="js-header"><a class="logo" href="https://patcave.me/">The Patcave</a><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu" aria-haspopup="true" aria-expanded="false"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">Menu</span></span></button><ul class="navbar__menu"><li><a href="https://patcave.me/" target="_self">Home</a></li><li><a href="https://patcave.me/about/" target="_self">About</a></li><li class="has-submenu"><span class="is-separator" aria-haspopup="true">Contact</span><ul class="navbar__submenu level-2" aria-hidden="true"><li><a href="https://www.linkedin.com/in/pmhennessy/" target="_blank">LinkedIn</a></li><li><a href="https://github.com/ns-phennessy" target="_blank">Github</a></li><li><a href="https://www.youtube.com/channel/UCIw-YA385k1S5IOwYD-iV5Q" target="_blank">YouTube</a></li><li><a href="https://tf2maps.net/members/zeus.28272/" target="_blank">TF2Maps.net</a></li><li><a href="mailto:phennessy517@gmail.com" target="_blank">Email</a></li></ul></li></ul></nav></header><main><article class="post"><div class="hero"><figure class="hero__image hero__image--overlay"><img src="https://patcave.me/media/posts/12/blueprints.png" srcset="https://patcave.me/media/posts/12/responsive/blueprints-xs.png 300w, https://patcave.me/media/posts/12/responsive/blueprints-sm.png 480w, https://patcave.me/media/posts/12/responsive/blueprints-md.png 768w, https://patcave.me/media/posts/12/responsive/blueprints-lg.png 1024w, https://patcave.me/media/posts/12/responsive/blueprints-xl.png 1360w, https://patcave.me/media/posts/12/responsive/blueprints-2xl.png 1600w" sizes="(max-width: 1600px) 100vw, 1600px" loading="eager" height="1080" width="1920" alt=""></figure><header class="hero__content"><div class="wrapper"><div class="post__meta"><time datetime="2022-03-15T19:53">March 15, 2022</time></div><h1>TF2Maps Infrastructure Overhaul Project</h1></div></header></div><div class="wrapper post__entry"><p>I have been Technical Staff at <a href="https://tf2maps.net">TF2Maps.net</a> for about a year as of writing this. One of the big things that bothered me when I first got onboard was how disorganized and chaotic the state of the infrastructure was. There wasn't a lot of it but it was old and fragile, and soon to be some serious hardware issues that needed to be addressed.</p><hr><h2>Unexpected hardware failures</h2><p>Â </p><figure class="post__image post__image--right"><img loading="lazy" style="font-size: 18.4px; outline: 3px solid rgba(var(--primary-color-rgb), 0.55)  !important;" src="https://patcave.me/media/posts/12/download-1.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://patcave.me/media/posts/12/responsive/download-1-xs.jpg 300w, https://patcave.me/media/posts/12/responsive/download-1-sm.jpg 480w, https://patcave.me/media/posts/12/responsive/download-1-md.jpg 768w, https://patcave.me/media/posts/12/responsive/download-1-lg.jpg 1024w, https://patcave.me/media/posts/12/responsive/download-1-xl.jpg 1360w, https://patcave.me/media/posts/12/responsive/download-1-2xl.jpg 1600w" alt="" width="266" height="116"></figure><p>In November of 2021, we discovered that our <span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);">hardware was beginning to fail. We had been running a physical host out of a New York </span><a href="https://en.wikipedia.org/wiki/Colocation_centre" style="font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);">colo</a><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);"> for nearly 8 years.</span></p><p>Usually disks and power supplies have a life of ~2-4 years, so its impressive we made it was far as we did, though scary because I was afraid our hardware could fail at basically any time.</p><p>In trying to allocate more disk to one of our VM's, our hypervisor <a href="https://www.proxmox.com/en/">Proxmox</a> told us that it detected bad sectors. Super oh no. These disks we're <a href="https://en.wikipedia.org/wiki/Standard_RAID_levels" target="_blank" rel="noopener noreferrer">RAID 0</a>, meaning we had no actual redundancy.</p><p>Additionally, our colo contract expired in February of 2022, meaning we would need to move all of our systems over to something new with the quickness.</p><hr><h2>Lay of the land</h2><p>The very first thing I did was assess the problem at hand and determine the scope of what we will do about it.</p><h4>So the obvious question is, what needs to move?</h4><p>I went onto every VM we had and took a thorough look to get an accounting of everything we would need to move or replace.</p><p>There was a lot more than I expected:</p><ul><li>Bind9 DNS</li><li>Dovecot Email server</li><li>Apache with 22 distinct virtual hosts<ul><li>Many of which were just static html sites</li><li>One was the forum software</li><li>One was our custom built map queue site</li></ul></li><li>The Discord Bot</li><li>MySQL database</li><li>Almost 1TB of static attachment data on disk</li></ul><h4>Bills Bills Bills</h4><p>I also spoke with the incumbent system administrator about hosting cost; which I had found we were consistently spending more on hosting than we received in donations, and the difference came out of his pocket. Not great, and he defiantly was not happy with it.</p><p>After some research, I determined that we would likely need to upgrade our version of the <a href="https://xenforo.com/">Xenforo </a>fo<span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);">rum software. So I tasked one of my "interns" with going into Xenforo and evaluate every existing plugin we ran on the old site, and asses it's criticality (must have, nice to have, dont need), as </span><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);">well as if we have a migration path for that plugin to Xenforo 2.</span></p><p><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);">This research was critical to learning if this was even possible, or if we would need to look into other solutions.</span></p><p><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);">Side note: Google</span><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);">Â Sprea</span><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);">dsheets are</span><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);"> great for this kind of ongoing collaboration:</span></p><div class="gallery-wrapper"><div class="gallery" data-is-empty="false" data-columns="1"><figure class="gallery__item"><a href="https://patcave.me/media/posts/12/gallery/Screenshot_774-3.png" data-size="920x666"><img loading="lazy" src="https://patcave.me/media/posts/12/gallery/Screenshot_774-3-thumbnail.png" alt="" width="720" height="521"></a></figure></div></div><hr><h2>Project Objectives</h2><ul><li>Have fully operational systems moved to new hardware before our colo contract expired</li><li>Reduce our hosting bill by at least 25%, but ideally as much as possible</li><li>Lower the maintenance overhead for all systems going forward</li><li>Bring us up to latest security best practices</li></ul><h3>Where to host it all?</h3><p>So the first order of business was to see what our hosting options could be. At a glance I figured we could leverage a cloud provider to replace a good amount of functionality for us, as well as possibly use S3 to host a lot of stuff for very cheap.</p><p>I put together a cost estimate for...</p><ul><li><a href="https://aws.amazon.com/">AWS</a></li><li><a href="https://www.digitalocean.com/">Digital Ocean</a></li><li><a href="https://www.vultr.com/">Vultr</a></li><li><a href="https://us.ovhcloud.com/">OVH</a></li></ul><figure class="post__image post__image--left"><img loading="lazy" style="font-size: 18.4px; outline: 3px solid rgba(var(--primary-color-rgb), 0.55)  !important;" src="https://patcave.me/media/posts/12/grmuy1fs409mjcg3xrqs-md.png" sizes="(max-width: 48em) 100vw, 768px" srcset="https://patcave.me/media/posts/12/responsive/grmuy1fs409mjcg3xrqs-md-xs.png 300w, https://patcave.me/media/posts/12/responsive/grmuy1fs409mjcg3xrqs-md-sm.png 480w, https://patcave.me/media/posts/12/responsive/grmuy1fs409mjcg3xrqs-md-md.png 768w, https://patcave.me/media/posts/12/responsive/grmuy1fs409mjcg3xrqs-md-lg.png 1024w, https://patcave.me/media/posts/12/responsive/grmuy1fs409mjcg3xrqs-md-xl.png 1360w, https://patcave.me/media/posts/12/responsive/grmuy1fs409mjcg3xrqs-md-2xl.png 1600w" alt="" width="237" height="181"></figure><p>AWS was cost prohibitive, though would have been the most feature rich one. OVH would mostly put us in a simliar situation as before.</p><p>So it was between DigitalOcean and Vultr. We ended up choosing Vultr because it had some slightly cheaper VM options and it has <em>way</em> more locations; which will be nice for ad-hoc game servers.</p><h3>Bill reduction strategy</h3><p>We had a lot of inefficiency in our hosting that we could fix.Â </p><p>First was all the static HTML sites we were serving. Vultr has an S3-type offering, so I assigned my "intern" the task of moving all of those sites into there. This will save us overhead on disk and also on just having less things to manage overall, since its setup and forget.</p><p>This was also a test for me to see how well their S3 setup works. The biggest hurdle was going to be figuring out if we can store our terabyte of attachment data out of S3 as well. A disk of that size for Vultr was going to be very expensive.Â </p><p>In researching this, I learned I could only do this if we upgraded our Xenforo software to 2+ (we were still running 1.4). However this was possible to do, even though there were no docs specifically for Vultr, I was able to figure out how to do this. Xenforo 2 also allowed us to do a lot of things we had wanted to do for many years but were unable to because of XF 1 limitations.</p><p>Coupled with the cheap VM's that are offered by Vultr, and the use of S3 as a backend, as well as ad-hoc game servers; I believed we could significantly reduce our hosting cost this way.</p><hr><h2>The Prototypes</h2><p>Â </p><figure class="post__image post__image--left"><img loading="lazy" src="https://patcave.me/media/posts/12/prototype-comic-2-en.png" sizes="(max-width: 48em) 100vw, 768px" srcset="https://patcave.me/media/posts/12/responsive/prototype-comic-2-en-xs.png 300w, https://patcave.me/media/posts/12/responsive/prototype-comic-2-en-sm.png 480w, https://patcave.me/media/posts/12/responsive/prototype-comic-2-en-md.png 768w, https://patcave.me/media/posts/12/responsive/prototype-comic-2-en-lg.png 1024w, https://patcave.me/media/posts/12/responsive/prototype-comic-2-en-xl.png 1360w, https://patcave.me/media/posts/12/responsive/prototype-comic-2-en-2xl.png 1600w" alt="" width="299" height="261"></figure>There was a lot of unknowns going into this. This site has existed since 2007, there was literally 13 years of data we <em>absolutely could not lose</em>. If that data was lost it would be gone forever.Â <p></p><p>So, I created a clean install of Xenforo 2 on a fresh Vultr VM so we could see what we wanted to end state to be.</p><p>Â </p><p>This prototype had no data in the db or attachments. It was done this way to make it faster to setup and also reduce any conversion issues, and it was way cheaper. I wanted a clean reference setup. We got setup with the plugins we evaluated in the research steps from earlier.</p><p>We spent probably a month or so working on setting this up and getting familiar with Xenforo 2. I also assigned my "intern" the task of setting up a UI theme to be reminiscent of our branding and old website, built off a more modern base. We quickly realized how many hacks the old site had in its CSS and theme so that was a fun adventure in CSS and HTML, something I haven't done much of in a long time.</p><p>The next prototype site I stood up was to clone the existing site sans attachments. It's purpose was to test the migration path from 1 to 2. Basically, what are we going to run into when we do this for real? The process was actually pretty smooth, though there were a bunch of non-critical things that didn't make it over cleanly, and we had to come back later and fix those up.Â </p><hr><h2>The Great Migration</h2><p>Â </p><figure class="post__image post__image--right"><img loading="lazy" src="https://patcave.me/media/posts/12/download.png" sizes="(max-width: 48em) 100vw, 768px" srcset="https://patcave.me/media/posts/12/responsive/download-xs.png 300w, https://patcave.me/media/posts/12/responsive/download-sm.png 480w, https://patcave.me/media/posts/12/responsive/download-md.png 768w, https://patcave.me/media/posts/12/responsive/download-lg.png 1024w, https://patcave.me/media/posts/12/responsive/download-xl.png 1360w, https://patcave.me/media/posts/12/responsive/download-2xl.png 1600w" alt="" width="263" height="167"></figure>For most of January, I was rather busy given that my startup had just been <a href="https://narrativescience.com/resource/blog/narrative-science-signs-agreement-to-be-acquired-by-salesforce">acquired by Salesforce</a>, so my head was not really in a good space to work on this infra for TF2Maps. However the deadline was fast approaching, so we set a time and sent out the announcement.<p></p><p>We had started moving some items in January in preparation of the VM move:</p><ul><li>DNS served out of Vultr</li><li>Email from a free email provider</li><li>Static HTML sites</li><li>Discord Bot</li><li><a href="https://patcave.me/game-server-monitoring/">Grafana</a></li></ul><p>There was absolutely no way to do this without taking the site offline while data moved. Thankfully, nothing bad happens if it goes down for a few days unlike production sites at work.Â </p><p>The VM move was a tense 3 days. If something in this process failed we may have lost a lot of data, so we needed to be very precise and methodical.</p><ol><li>Create new (final) VM for the Xenforo site</li><li>Put up a maintenance page to totally prevent any DB writes from occuring</li><li>Move the SQL databases onto new VM, save a backup in S3</li><li>Attach a 1TB disk to the VM, and start the static file sync<ul><li>This ended up taking 3 days to complete</li></ul></li><li>Clone the Xenforo 1 site</li><li>Once all data was sync'd, perform the upgrade</li><li>Setup all the new things we needed to do, including the theme</li><li>Create a thread on the forums for end users to report bugs</li><li>Let Staff member inspect the site and knock out some obvious issues first</li><li>Open it up to the public (this was scary)</li></ol><hr><h2>The Post Migration Chaos</h2><p>As usual with projects like this, we got hundreds of bug reports and small issues.</p><p>To add to this, our first salvo was just to get us out of the colo expiration problem. We had not actually moved our attachments into S3, or created ad-hoc servers.</p><p>We would not be able to realize our cost savings until we had finally moved attachment data into S3. Again, this was easy because I already knew what to do because of the prototype phase we did. I had to once again take the site offline for a few days to do this. Once moved, I detached the disk, but kept it around as a hot backup incase something really went wrong with S3. After a week, I shutdown that disk, given it was quite expensive.</p><p>I assigned as many bugs to my intern as I felt he could reasonably handle while I tackled the more difficult ones. Together, we ended up fixing probably 50 issues over the course of a few weeks.Â </p><hr><h2>A major upgrade to security</h2><p>Now I don't want to knock on the people who set things up before I came along because they did a good job of just keeping the ship floating, but lets just say the state of security was a bit, uhhh, <a href="https://www.merriam-webster.com/dictionary/ramshackle">ramshackle</a>.Â </p><p>Thankfully, I've done server hardening many many times before. Over the next few weeks I worked on setting up:</p><ul><li>Least privilege database users</li><li>SSH key authentication only</li><li>No root user logins</li><li>SSH whitelisted to only administrators IP's</li><li>Stateful firewall (fail2ban)</li><li>Ulimits</li><li>Apache vhosts run in sandboxes from one another</li><li>Wildcard SSL cert from letsencrypt that automatically renews itself</li><li>Least priviledge firewalls inside of Vultr</li><li>Forced HTTPS redirection</li></ul><hr><h2>Outcomes</h2><ul><li>Data move completed with 3 days to spare!</li><li><em>We did not lose any data whatsoever</em></li><li>The steady state hosting cost was reduced by 65%!</li><li>Security is a lot better now</li><li>Automation now exists for all the mundane things<ul><li>Automatic DB backups to S3 on a weekly cadance</li><li>Automatic SSL renewal</li><li>Xenforo -&gt; Discord rank syncing</li></ul></li><li>The site is much better protected from disasters given most of the data is in S3 and the rest is regularly backed up</li><li>Multiple people on Staff can now help me operate the site thanks to Xenforo 2 being a lot easier to administer.</li></ul><figure class="post__image post__image--center"><img loading="lazy" src="https://patcave.me/media/posts/12/great-success.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://patcave.me/media/posts/12/responsive/great-success-xs.jpg 300w, https://patcave.me/media/posts/12/responsive/great-success-sm.jpg 480w, https://patcave.me/media/posts/12/responsive/great-success-md.jpg 768w, https://patcave.me/media/posts/12/responsive/great-success-lg.jpg 1024w, https://patcave.me/media/posts/12/responsive/great-success-xl.jpg 1360w, https://patcave.me/media/posts/12/responsive/great-success-2xl.jpg 1600w" alt="" width="576" height="432"></figure><hr><h2>Learnings</h2><p>To be successful here, I had to wear a lot of different hats. I was basically the lead developer, project manager, ui designer, QA, security, and finance. I had a few people who were technical enough I could slice off some simple tasks and assign them to those people which did help a lot.</p><p>The most difficult thing to do was cut through all the people wanting to just slap something out there, and managing expectations. Most of the people involved have not been a part of a project such as this before so I had to also wear the hat of the mentor. I had to guide everyone through a process which I had developed from doing migration projects like this at work. I have a systematic process to do this, but it was defiantly challenging getting folks onboard and to trust that I knew what I was doing. There was a great deal of skepticism that I would be able to actually pull this off, and to a degree, I was unsure if I would actually be able to deliver on some of the goals, mostly relating to cost optimization. The research step helped ease a lot of peoples concerns because I have proof that we would be able to actually pull this off.</p><p>The other thing to do was managing the expectations of our user base. We probably have about 1000 active users, so we got absolutely slammed with requests for a few weeks. My intern helped triage a lot of this stuff which was a nice burden off my shoulders, since I could focus on much bigger picture things. Of course every person feels the issue they are reporting is the most important one and you have to be patient and communicate that we acknowledge the issue and we are going to get to it when we can given its difficulty to fix and its value to the community as a whole. Some issues however we probably just aren't going to fix because they're so difficult and low value, and you have to accept that in projects like this, those things are going to happen.</p><p>Another thing I did here was to coach the rest of staff to act on my behalf and get in front of issues and snowballing discussions about the new site. I defiantly succeeded here in rallying dozens of people to assist me when I needed it. I think the key to this is being transparent and very clear about what you need from them.</p><hr><h2>The Process in Bullet form</h2><ol><li>Assess the scope of the problem at hand, i.e. what do we need to solve for?</li><li>Research solutions<ul><li>Create prototypes to learn about a solution so you can pivot your research if needed</li><li>Setup cost estimates</li><li>Estimate the scope of work involved, and determine the must-haves<ul><li>Try to organize the work such that you can farm out to multiple people</li></ul></li></ul></li><li>Prioritize work based on the constraints of the problem (such as our colo contract expiration)</li><li>Action the minimum critical scope as your first salvo</li><li>Openly seek feedback</li><li>Iterate on improvements and bug fixes until completion</li></ol><p>Don't forget to openly communicate to stakeholders about where you are in this process and be open about your unknowns. Seek to resolve those unknowns in your research as much as possible.</p></div><footer class="wrapper post__footer"><ul class="post__tag"><li><a href="https://patcave.me/tags/gaming/">Gaming</a></li><li><a href="https://patcave.me/tags/computer-science/">Programming Stuff</a></li></ul></footer></article><nav class="post__nav"><div class="post__nav-inner"><div class="post__nav-prev"><svg width="1.041em" height="0.416em" aria-hidden="true"><use xlink:href="https://patcave.me/assets/svg/svg-map.svg#arrow-prev"/></svg> <a href="https://patcave.me/my-choice-tools-for-cloud-engineering/" class="invert post__nav-link" rel="prev"><span>Previous</span> My choice tools for Cloud Engineering</a></div></div></nav></main><footer class="footer"><div class="footer__copyright"><p>Â© Patrick Hennessy 2014 - 2022</p></div></footer></div><script>window.publiiThemeMenuConfig = {    
        mobileMenuMode: 'sidebar',
        animationSpeed: 300,
        submenuWidth: 'auto',
        doubleClickTime: 500,
        mobileMenuExpandableSubmenus: true, 
        relatedContainerForOverlayMenuSelector: '.top',
   };</script><script defer="defer" src="https://patcave.me/assets/js/scripts.min.js?v=48e9576b9741cf2a93ab25c5689c9f5d"></script><script>var images = document.querySelectorAll('img[loading]');

        for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
                images[i].classList.add('is-loaded');
            } else {
                images[i].addEventListener('load', function () {
                    this.classList.add('is-loaded');
                }, false);
            }
        }</script><script defer="defer" src="https://patcave.me/assets/js/photoswipe.min.js?v=b586a3bc288c989ecce7b81b48e35855"></script><script defer="defer" src="https://patcave.me/assets/js/photoswipe-ui-default.min.js?v=9952f77ca2b8fbc9449a268008ea8dee"></script><script>var initPhotoSwipeFromDOM=function(gallerySelector){var parseThumbnailElements=function(el){var thumbElements=el.childNodes,numNodes=thumbElements.length,items=[],figureEl,linkEl,size,item;for(var i=0;i<numNodes;i++){figureEl=thumbElements[i];if(figureEl.nodeType!==1){continue;}
          linkEl=figureEl.children[0];size=linkEl.getAttribute('data-size').split('x');item={src:linkEl.getAttribute('href'),w:parseInt(size[0],10),h:parseInt(size[1],10)};if(figureEl.children.length>1){item.title=figureEl.children[1].innerHTML;}
          if(linkEl.children.length>0){item.msrc=linkEl.children[0].getAttribute('src');}
          item.el=figureEl;items.push(item);}
          return items;};var closest=function closest(el,fn){return el&&(fn(el)?el:closest(el.parentNode,fn));};var onThumbnailsClick=function(e){e=e||window.event;e.preventDefault?e.preventDefault():e.returnValue=false;var eTarget=e.target||e.srcElement;var clickedListItem=closest(eTarget,function(el){return(el.tagName&&el.tagName.toUpperCase()==='FIGURE');});if(!clickedListItem){return;}
          var clickedGallery=clickedListItem.parentNode,childNodes=clickedListItem.parentNode.childNodes,numChildNodes=childNodes.length,nodeIndex=0,index;for(var i=0;i<numChildNodes;i++){if(childNodes[i].nodeType!==1){continue;}
          if(childNodes[i]===clickedListItem){index=nodeIndex;break;}
          nodeIndex++;}
          if(index>=0){openPhotoSwipe(index,clickedGallery);}
          return false;};var photoswipeParseHash=function(){var hash=window.location.hash.substring(1),params={};if(hash.length<5){return params;}
          var vars=hash.split('&');for(var i=0;i<vars.length;i++){if(!vars[i]){continue;}
          var pair=vars[i].split('=');if(pair.length<2){continue;}
          params[pair[0]]=pair[1];}
          if(params.gid){params.gid=parseInt(params.gid,10);}
          return params;};var openPhotoSwipe=function(index,galleryElement,disableAnimation,fromURL){var pswpElement=document.querySelectorAll('.pswp')[0],gallery,options,items;items=parseThumbnailElements(galleryElement);options={galleryUID:galleryElement.getAttribute('data-pswp-uid'),getThumbBoundsFn:function(index){var thumbnail=items[index].el.getElementsByTagName('img')[0],pageYScroll=window.pageYOffset||document.documentElement.scrollTop,rect=thumbnail.getBoundingClientRect();return{x:rect.left,y:rect.top+pageYScroll,w:rect.width};},
          mainClass:'pswp--dark',
          preload: [1,2],
          hideAnimationDuration:200,
          showAnimationDuration:0,
          bgOpacity: 0.7,
          showHideOpacity:true,
          closeOnScroll: true,
          arrowKeys: true,
          closeEl: true,
          captionEl: true,
          fullscreenEl: false,
          zoomEl: false,
          shareEl: false,
          counterEl: false,
          arrowEl: true,
          preloaderEl: true
          };if(fromURL){if(options.galleryPIDs){for(var j=0;j<items.length;j++){if(items[j].pid==index){options.index=j;break;}}}else{options.index=parseInt(index,10)-1;}}else{options.index=parseInt(index,10);}
          if(isNaN(options.index)){return;}
          if(disableAnimation){options.showAnimationDuration=0;}
          gallery=new PhotoSwipe(pswpElement,PhotoSwipeUI_Default,items,options);gallery.init();gallery.options.maxSpreadZoom = gallery.getZoomLevel();gallery.options.getDoubleTapZoom = function(isMouseClick, item) {return item.initialZoomLevel;};gallery.options.escKey=true;};var galleryElements=document.querySelectorAll(gallerySelector);for(var i=0,l=galleryElements.length;i<l;i++){galleryElements[i].setAttribute('data-pswp-uid',i+1);galleryElements[i].onclick=onThumbnailsClick;}
          var hashData=photoswipeParseHash();if(hashData.pid&&hashData.gid){openPhotoSwipe(hashData.pid,galleryElements[hashData.gid-1],true,true);}};window.addEventListener('load', function () {initPhotoSwipeFromDOM('.gallery');}, false);</script><div class="pswp" tabindex="-1" role="dialog" aria-hidden="true"><div class="pswp__bg"></div><div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div><div class="pswp__item"></div><div class="pswp__item"></div></div><div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button><button class="pswp__button pswp__button--share" title="Share"></button><button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button><button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button><button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div></body></html>